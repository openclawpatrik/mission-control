<!doctype html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mission Control</title>
  <style>
    :root{--bg:#050912;--bg2:#0a1222;--panel:#0f1a31cc;--line:#28406a;--text:#eaf1ff;--muted:#9ab0d9;--red:#ff5c7a;--yellow:#ffcd59;--blue:#61b2ff;--green:#44d695;--radius:14px}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;color:var(--text);font:14px/1.45 Inter,system-ui,Segoe UI,Roboto,Arial;background:
      radial-gradient(1200px 500px at 10% 100%, rgba(255,90,120,.12), transparent 60%),
      radial-gradient(900px 500px at 80% 20%, rgba(87,159,255,.14), transparent 60%),
      linear-gradient(180deg,var(--bg),var(--bg2));overflow-x:hidden}

    .topbar{position:sticky;top:0;z-index:50;display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#070e1dcf;border-bottom:1px solid var(--line);backdrop-filter:blur(10px)}
    .brand{display:flex;align-items:center;gap:10px}.logo{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(145deg,#243f72,#132747)}
    .title{font-weight:800;letter-spacing:.08em}.subtitle{font-size:12px;color:var(--muted)}
    .topstats{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #345286;background:#0e1c35;color:#d6e5ff}
    .btn{font-size:12px;padding:6px 11px;border-radius:999px;border:1px solid #4a5f8f;background:#17233f;color:#dce8ff;cursor:pointer}
    .btn:hover{background:#1d2d50}

    .app{max-width:2000px;margin:0 auto;padding:12px;display:grid;grid-template-columns:280px minmax(980px,1fr) 300px;gap:12px}
    .panel{border:1px solid var(--line);border-radius:var(--radius);background:var(--panel);box-shadow:0 14px 30px rgba(0,0,0,.28)}
    .section-h{display:flex;justify-content:space-between;align-items:center;padding:10px 10px 8px;color:#bdd0f3;font-size:12px;text-transform:uppercase;letter-spacing:.12em}

    .side,.ops{padding:8px;min-height:calc(100vh - 90px)}
    .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
    .stat{background:linear-gradient(180deg,#142646,#101d36);border:1px solid #35568d;border-radius:12px;padding:8px}
    .stat .k{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    .stat .v{font-size:18px;font-weight:800;line-height:1.2;margin-top:2px}

    .agent{display:flex;gap:10px;align-items:center;background:linear-gradient(180deg,#132543,#0f1d35);border:1px solid #2f4b78;border-radius:12px;padding:8px;margin-bottom:8px}
    .avatar{width:42px;height:42px;border-radius:8px;object-fit:cover;border:1px solid #4168a8;image-rendering:pixelated;background:#dfe4ee;padding:2px}
    .a-meta b{display:block;font-size:13px}.a-role{font-size:12px;color:var(--muted)}
    .badge{margin-left:auto;font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid #315288;background:#11213d;color:#d2e2ff;display:flex;gap:5px;align-items:center}

    .board-wrap{padding:8px;overflow:auto}
    .board{display:grid;grid-template-columns:repeat(6,minmax(210px,1fr));gap:10px;min-width:1320px}
    .col{border:1px solid #2b4068;border-radius:12px;padding:8px;min-height:530px;background:linear-gradient(180deg,rgba(12,21,38,.88),rgba(10,18,34,.88));position:relative;overflow:hidden}
    .col::after{content:'';position:absolute;inset:auto -40% -45% -40%;height:120px;filter:blur(30px);opacity:.35;pointer-events:none}
    .colhead{display:flex;justify-content:space-between;align-items:center;padding:7px 9px;border-radius:10px;border:1px solid #355489;background:#132748;margin-bottom:8px}
    .coltitle{font-size:12px;text-transform:uppercase;letter-spacing:.08em;font-weight:700}
    .count{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid #45689d;background:#18325a;color:#ddecff}
    .soft-limit{box-shadow:0 0 0 1px rgba(255,205,89,.5) inset}

    .col-backlog .colhead{border-color:#7b3a4b;background:linear-gradient(180deg,#331821,#261118)} .col-backlog::after{background:radial-gradient(circle,var(--red),transparent 60%)}
    .col-ready .colhead{border-color:#2d6f86;background:linear-gradient(180deg,#132f3a,#112731)} .col-ready::after{background:radial-gradient(circle,#59d4ff,transparent 60%)}
    .col-doing .colhead{border-color:#816529;background:linear-gradient(180deg,#342a14,#261d0e)} .col-doing::after{background:radial-gradient(circle,var(--yellow),transparent 60%)}
    .col-blocked .colhead{border-color:#7f3f97;background:linear-gradient(180deg,#2d1837,#25132d)} .col-blocked::after{background:radial-gradient(circle,#d47bff,transparent 60%)}
    .col-review .colhead{border-color:#3f6ba7;background:linear-gradient(180deg,#142943,#11243a)} .col-review::after{background:radial-gradient(circle,var(--blue),transparent 60%)}
    .col-done .colhead{border-color:#2c7a60;background:linear-gradient(180deg,#132b22,#10231c)} .col-done::after{background:radial-gradient(circle,var(--green),transparent 60%)}

    .card{position:relative;z-index:1;background:linear-gradient(180deg,#142646,#101d36);border:1px solid #35568d;border-radius:12px;padding:10px;margin-bottom:9px;cursor:pointer}
    .meta{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px}
    .tag{font-size:11px;padding:2px 7px;border-radius:999px;border:1px solid #43689f;background:#17305a;color:#d7e6ff}
    .prio-H{border-color:#8e4359;background:#3a1721;color:#ffc3cf}
    .prio-M{border-color:#8d6f2e;background:#3a2d12;color:#ffe2a0}
    .prio-L{border-color:#2f8a6d;background:#143426;color:#b8f5da}
    .next{font-size:12px;color:#c5d6f5;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden}

    .ops-box{background:linear-gradient(180deg,#132543,#0f1d35);border:1px solid #2f4b78;border-radius:12px;padding:8px;margin-bottom:8px}
    .ops-row{display:flex;justify-content:space-between;align-items:center;font-size:12px;margin:6px 0}
    .dot{width:8px;height:8px;border-radius:999px;display:inline-block;margin-right:6px}
    .g{background:#33d08f}.y{background:#f0c24e}.r{background:#ff637f}

    .empty{color:var(--muted);font-size:12px;opacity:.8}

    .modal{display:none;position:fixed;inset:0;background:rgba(3,8,18,.75);z-index:80;align-items:center;justify-content:center;padding:18px}
    .modal-card{width:min(900px,95vw);max-height:85vh;overflow:auto;background:#0f1a31;border:1px solid #2f4d82;border-radius:14px;box-shadow:0 20px 50px rgba(0,0,0,.55);padding:12px}

    @media (max-width:1280px){.app{grid-template-columns:1fr}.side,.ops{min-height:auto}}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand"><div class="logo">üõ∞Ô∏è</div><div><div class="title">MISSION CONTROL</div><div class="subtitle" id="updated">Laddar data‚Ä¶</div></div></div>
    <div class="topstats" id="topstats"></div>
  </header>

  <main class="app">
    <aside class="panel side"><div class="section-h"><span>Agents</span><span id="agentCount"></span></div><div id="agents"></div></aside>
    <section class="panel board-wrap"><div class="board" id="board"></div></section>
    <aside class="panel ops">
      <div class="section-h"><span>System Status</span><span id="statsUpdated"></span></div>
      <div class="stats-grid" id="stats"></div>
      <div class="section-h" style="padding-top:2px"><span>Tool Status</span><span>Telegram + exec</span></div>
      <div class="ops-box" id="ops"></div>
    </aside>
  </main>

  <div id="archiveModal" class="modal"><div class="modal-card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;"><b>Archived Tasks</b><button id="closeArchive" class="btn">St√§ng</button></div><div id="archiveList" class="empty">Inga arkiverade tasks.</div></div></div>
  <div id="cardModal" class="modal"><div class="modal-card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;"><b>Task details</b><button id="closeCard" class="btn">St√§ng</button></div><div id="cardDetail"></div></div></div>

<script>
const AVATAR_VER='v5';
const TEAM=[
  {name:'Max Mercer',role:'Orchestrator & priorities',state:'Active',avatar:`./avatars/max-mercer.png?${AVATAR_VER}`},
  {name:'Nina Sparks',role:'Research & trend radar',state:'Active',avatar:`./avatars/nina-sparks.png?${AVATAR_VER}`},
  {name:'Leo Byte',role:'Builder & app maker',state:'Idle',avatar:`./avatars/leo-byte.png?${AVATAR_VER}`},
  {name:'Ivy Shield',role:'QA & risk guardian',state:'Idle',avatar:`./avatars/ivy-shield.png?${AVATAR_VER}`},
  {name:'Owen Flux',role:'Ops & automation',state:'Active',avatar:`./avatars/owen-flux.png?${AVATAR_VER}`}
];
const STATE_META={Working:{icon:'üü¢',cls:'state-working',text:'Working'},Active:{icon:'‚ö°',cls:'state-active',text:'Active'},Idle:{icon:'üåô',cls:'state-idle',text:'Idle'},Review:{icon:'üîé',cls:'state-review',text:'Review'}};
const WIP={doing:2,review:2};
const COLS=[['backlog','Backlog'],['doing','In Progress'],['review','Review'],['done','Done']];
let FOCUS=false; let LAST_ARCHIVE={archived:[]}; let TOOL_STATUS={telegram:'OK',exec:'OK'};
const byId=id=>document.getElementById(id); const el=(t,c,h)=>{const e=document.createElement(t);if(c)e.className=c;if(h!==undefined)e.innerHTML=h;return e};

function renderTopStats(data, archivedCount=0){
  const top=byId('topstats'); top.innerHTML='';
  const vals={backlog:(data.columns.backlog||[]).length,doing:(data.columns.doing||[]).length,review:(data.columns.review||[]).length,done:(data.columns.done||[]).length};
  [`Backlog ${vals.backlog}`,`In Progress ${vals.doing}/${WIP.doing}`,`Review ${vals.review}/${WIP.review}`,`Done ${vals.done}`,`Archived ${archivedCount}`,`Agents ${TEAM.length}`]
  .forEach(x=>top.appendChild(el('span','pill',x)));
  const focusBtn=el('button','btn',FOCUS?'Exit Focus':'Focus Mode'); focusBtn.onclick=()=>{FOCUS=!FOCUS;load();}; top.appendChild(focusBtn);
  const archBtn=el('button','btn','üì¶ Archive'); archBtn.onclick=()=>byId('archiveModal').style.display='flex'; top.appendChild(archBtn);
}

function renderAgents(data){
  const wrap=byId('agents'); wrap.innerHTML='';
  const doing=(data.columns.doing||[]).length;
  TEAM.forEach((a,i)=>{
    const state=(i===0&&doing>0)?'Working':a.state; const meta=STATE_META[state]||STATE_META.Active;
    const card=el('div','agent',`<img class="avatar" src="${a.avatar}" alt="${a.name}"/><div class="a-meta"><b>${a.name}</b><div class="a-role">${a.role}</div></div><span class="badge ${meta.cls}"><span>${meta.icon}</span><span>${meta.text}</span></span>`);
    wrap.appendChild(card);
  });
  byId('agentCount').textContent=TEAM.length;
}

function renderCard(t,colKey){
  const card=el('article','card');
  const p=(t.priority||'M');
  // compact view: only Owner + Next action + Prio
  card.innerHTML=`<div class="meta"><span class="tag prio-${p}">Prio ${p}</span><span class="tag">${t.owner||'Bob'}</span></div><div class="next" title="${t.next_action||''}">${t.next_action||'(saknar next action)'}</div>`;
  card.onclick=()=>openCard(t,colKey);
  return card;
}

function renderBoard(data){
  const board=byId('board'); board.innerHTML='';
  const cols=FOCUS?COLS.filter(([k])=>['doing','review'].includes(k)):COLS;
  cols.forEach(([k,label])=>{
    const items=data.columns[k]||[];
    const col=el('section','col col-'+k);
    let countText=`${items.length}`;
    if(k==='doing') countText=`${items.length}/${WIP.doing}`;
    if(k==='review') countText=`${items.length}/${WIP.review}`;
    col.innerHTML=`<div class="colhead ${((k==='doing'&&items.length>=WIP.doing)||(k==='review'&&items.length>=WIP.review))?'soft-limit':''}"><div class="coltitle">${label}</div><div class="count">${countText}</div></div>`;
    if(!items.length) col.appendChild(el('div','empty','Inga kort.'));
    items.forEach(t=>col.appendChild(renderCard(t,k)));
    board.appendChild(col);
  });
}

function renderArchive(archiveData){
  const list=byId('archiveList'); const items=(archiveData&&archiveData.archived)?archiveData.archived:[];
  if(!items.length){list.innerHTML='<div class="empty">Inga arkiverade tasks.</div>';return;}
  list.innerHTML='';
  items.slice().reverse().forEach(t=>list.appendChild(el('div','agent',`<div class="a-meta"><b>${t.title||'Untitled'}</b><div class="a-role">${t.next_action||''}</div><div class="a-role">Arkiverad: ${t.archived_at?new Date(t.archived_at).toLocaleString('sv-SE'):''}</div></div>`)));
}

function openCard(t,colKey){
  const dod=(t.definition_of_done && t.definition_of_done.length)?t.definition_of_done:['(saknas)'];
  const risk=t.risk||'M';
  const approval=t.approval_required?'<span class="tag" style="border-color:#8e4359;background:#3a1721;color:#ffc3cf">Approval required</span>':'';
  const blocked=(colKey==='blocked' && t.blocked_reason)?`<p><b>Blocked reason:</b> ${t.blocked_reason}</p>`:'';
  byId('cardDetail').innerHTML=`
    <h3 style="margin:0 0 8px">${t.title||'Untitled'}</h3>
    <p><b>Owner:</b> ${t.owner||'Bob'}</p>
    <p><b>Next action:</b> ${t.next_action||'(saknas)'}</p>
    <p><b>Risk:</b> <span class="tag">${risk}</span> ${approval}</p>
    <p><b>Definition of Done:</b></p>
    <ul>${dod.map(x=>`<li>${x}</li>`).join('')}</ul>
    ${blocked}
  `;
  byId('cardModal').style.display='flex';
}

function levelPercent(v){
  if(v===null||v===undefined||Number.isNaN(Number(v))) return '';
  v=Number(v); if(v<60) return 'g'; if(v<80) return 'y'; return 'r';
}
function renderStats(stats){
  const wrap=byId('stats');
  if(!stats){ wrap.innerHTML='<div class="empty">Ingen systemdata √§nnu.</div>'; return; }
  const cpu=stats.cpu?.used_percent ?? '-';
  const ram=stats.ram?.used_percent ?? '-';
  const disk=stats.disk?.used_percent ?? '-';
  const temp=(stats.temperature?.cpu_c ?? 'N/A');
  const rx=(stats.network?.rx_kbps ?? '-');
  const tx=(stats.network?.tx_kbps ?? '-');
  wrap.innerHTML='';
  wrap.appendChild(el('div','stat',`<div class='k'>CPU</div><div class='v'>${cpu}%</div>`));
  wrap.appendChild(el('div','stat',`<div class='k'>RAM</div><div class='v'>${ram}%</div>`));
  wrap.appendChild(el('div','stat',`<div class='k'>Disk</div><div class='v'>${disk}%</div>`));
  wrap.appendChild(el('div','stat',`<div class='k'>Temp</div><div class='v'>${temp}</div>`));
  wrap.appendChild(el('div','stat',`<div class='k'>Net RX</div><div class='v'>${rx} KB/s</div>`));
  wrap.appendChild(el('div','stat',`<div class='k'>Net TX</div><div class='v'>${tx} KB/s</div>`));
  byId('statsUpdated').textContent = stats.updated_at ? new Date(stats.updated_at).toLocaleTimeString('sv-SE') : '';
}
function renderOps(){
  const ops=byId('ops');
  const tool = (TOOL_STATUS.telegram==='OK' && TOOL_STATUS.exec==='OK') ? 'OK' : ((TOOL_STATUS.telegram==='DOWN'||TOOL_STATUS.exec==='DOWN')?'DOWN':'DEGRADED');
  const dot = tool==='OK'?'g':(tool==='DEGRADED'?'y':'r');
  ops.innerHTML=`<div class='ops-row'><span><span class='dot ${dot}'></span><b>Tool status</b></span><span>${tool}</span></div><div class='ops-row'><span class='muted'>Telegram</span><span>${TOOL_STATUS.telegram}</span></div><div class='ops-row'><span class='muted'>exec</span><span>${TOOL_STATUS.exec}</span></div>`;
}

async function load(){
  try{
    const ts=Date.now();
    const [boardRes, archiveRes, statsRes]=await Promise.all([
      fetch('./KANBAN.json?ts='+ts),
      fetch('./KANBAN_ARCHIVE.json?ts='+ts).catch(()=>null),
      fetch('./system_stats.json?ts='+ts).catch(()=>null)
    ]);
    const data=await boardRes.json();
    let archivedCount=0; LAST_ARCHIVE={archived:[]};
    let stats=null;
    if(archiveRes&&archiveRes.ok){ LAST_ARCHIVE=await archiveRes.json(); archivedCount=(LAST_ARCHIVE.archived||[]).length; }
    if(statsRes&&statsRes.ok){ stats=await statsRes.json(); }

    byId('updated').textContent=`Senast uppdaterad: ${new Date().toLocaleString('sv-SE')}`;
    renderTopStats(data, archivedCount); renderAgents(data); renderBoard(data); renderArchive(LAST_ARCHIVE); renderStats(stats); renderOps();
  }catch{ byId('updated').textContent='Kunde inte l√§sa KANBAN.json'; TOOL_STATUS.exec='DEGRADED'; renderOps(); }
}

byId('closeArchive').onclick=()=>byId('archiveModal').style.display='none';
byId('archiveModal').addEventListener('click',e=>{if(e.target.id==='archiveModal')byId('archiveModal').style.display='none';});
byId('closeCard').onclick=()=>byId('cardModal').style.display='none';
byId('cardModal').addEventListener('click',e=>{if(e.target.id==='cardModal')byId('cardModal').style.display='none';});

load(); setInterval(load,10000);
</script>
</body>
</html>
