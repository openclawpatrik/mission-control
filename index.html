<!doctype html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FitzWorks Mission Control</title>
  <style>
    :root{--bg:#050912;--bg2:#0a1222;--panel:#0f1a31cc;--line:#28406a;--text:#eaf1ff;--muted:#9ab0d9;--radius:14px;--red:#ff5c7a;--yellow:#ffcd59;--blue:#61b2ff;--green:#44d695}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;color:var(--text);font:14px/1.45 Inter,system-ui,Segoe UI,Roboto,Arial;background:radial-gradient(1200px 500px at 10% 100%, rgba(255,90,120,.12), transparent 60%),radial-gradient(900px 500px at 80% 20%, rgba(87,159,255,.14), transparent 60%),linear-gradient(180deg,var(--bg),var(--bg2));overflow:hidden}

    .topbar{min-height:58px;display:grid;grid-template-columns:minmax(220px,1fr) auto minmax(420px,1fr);align-items:center;padding:8px 12px;border-bottom:1px solid var(--line);background:#070e1dcc;gap:10px}
    .brand{display:flex;gap:10px;align-items:center}.logo{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(145deg,#243f72,#132747)}
    .subtitle{font-size:12px;color:var(--muted)}
    .fitz{justify-self:center;font-weight:900;letter-spacing:.12em;font-size:18px;text-transform:uppercase;line-height:1}
    .fitz span{color:#7ad0ff}
    .topstats{justify-self:end;display:flex;gap:6px;align-items:center;flex-wrap:nowrap;white-space:nowrap;overflow:auto;scrollbar-width:none}
    .pill{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid #345286;background:#0e1c35;color:#d6e5ff;flex:0 0 auto}

    .shell{display:grid;grid-template-columns:220px 1fr;height:calc(100vh - 58px)}
    .sidebar{border-right:1px solid var(--line);padding:10px;background:#081226}
    .tab{display:block;width:100%;text-align:left;margin:4px 0;padding:9px 10px;border-radius:10px;border:1px solid transparent;background:transparent;color:#d7e7ff;cursor:pointer}
    .tab:hover{background:#12213c}.tab.active{background:#162949;border-color:#345286}

    .main{padding:10px;overflow:auto}
    .panel{border:1px solid var(--line);border-radius:var(--radius);background:var(--panel);box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .section-h{display:flex;justify-content:space-between;align-items:center;padding:10px;color:#bdd0f3;font-size:12px;text-transform:uppercase;letter-spacing:.12em}

    .tasks-layout{display:grid;grid-template-columns:1fr 320px;gap:10px}
    .board-wrap{padding:8px;overflow:auto}
    .board{display:grid;gap:10px;width:100%}
    .col{border:1px solid #2b4068;border-radius:12px;padding:8px;min-height:460px;background:linear-gradient(180deg,rgba(12,21,38,.88),rgba(10,18,34,.88))}
    .colhead{display:flex;justify-content:space-between;align-items:center;padding:7px 9px;border-radius:10px;border:1px solid #355489;background:#132748;margin-bottom:8px}
    .coltitle{font-size:12px;text-transform:uppercase;letter-spacing:.08em;font-weight:700}.count{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid #45689d;background:#18325a;color:#ddecff}
    .soft-limit{box-shadow:0 0 0 1px rgba(255,205,89,.5) inset}
    .col-backlog .colhead{border-color:#7b3a4b;background:linear-gradient(180deg,#331821,#261118)}
    .col-doing .colhead{border-color:#816529;background:linear-gradient(180deg,#342a14,#261d0e)}
    .col-review .colhead{border-color:#3f6ba7;background:linear-gradient(180deg,#142943,#11243a)}
    .col-done .colhead{border-color:#2c7a60;background:linear-gradient(180deg,#132b22,#10231c)}

    .card{background:linear-gradient(180deg,#142646,#101d36);border:1px solid #35568d;border-radius:12px;padding:10px;margin-bottom:8px;cursor:pointer}
    .agent-chip{display:flex;align-items:center;gap:6px;margin-bottom:6px}
    .agent-chip img{width:22px;height:22px;border-radius:6px;image-rendering:pixelated;border:1px solid #3b5e96;background:#dfe4ee;padding:1px}
    .tag{font-size:11px;padding:2px 7px;border-radius:999px;border:1px solid #43689f;background:#17305a;color:#d7e6ff}
    .prio-H{border-color:#8e4359;background:#3a1721;color:#ffc3cf}.prio-M{border-color:#8d6f2e;background:#3a2d12;color:#ffe2a0}.prio-L{border-color:#2f8a6d;background:#143426;color:#b8f5da}
    .next{font-size:12px;color:#c5d6f5;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden}
    .cat-chip{border-color:#5b4aa0;background:#1d1a3a;color:#d9d0ff}
    .progress{margin-top:8px}
    .progress-row{display:flex;justify-content:space-between;align-items:center;font-size:10px;color:var(--muted);margin-bottom:4px}
    .bar{height:6px;border-radius:999px;background:#10203a;border:1px solid #2b4774;overflow:hidden}
    .bar > span{display:block;height:100%;background:linear-gradient(90deg,#4fc3ff,#33d08f)}

    .btn{font-size:11px;padding:5px 9px;border-radius:999px;border:1px solid #4a5f8f;background:#17233f;color:#dce8ff;cursor:pointer;flex:0 0 auto}
    .agent-filter{font-size:11px;padding:5px 8px;border-radius:999px;border:1px solid #4a5f8f;background:#17233f;color:#dce8ff;max-width:120px}

    .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
    .stat{background:linear-gradient(180deg,#142646,#101d36);border:1px solid #35568d;border-radius:12px;padding:8px}
    .stat .k{font-size:11px;color:var(--muted);text-transform:uppercase}.stat .v{font-size:18px;font-weight:800}
    .stat-good{border-color:#2e8d66;background:linear-gradient(180deg,#123324,#0f271d)} .stat-good .v{color:#bff6dc}
    .stat-warn{border-color:#9a7a2f;background:linear-gradient(180deg,#352a12,#2a200e)} .stat-warn .v{color:#ffe4a1}
    .stat-bad{border-color:#9b4159;background:linear-gradient(180deg,#361722,#2a1118)} .stat-bad .v{color:#ffc2cf}
    .ops-box{background:linear-gradient(180deg,#132543,#0f1d35);border:1px solid #2f4b78;border-radius:12px;padding:8px;margin-bottom:8px}
    .ops-row{display:flex;justify-content:space-between;align-items:center;font-size:12px;margin:6px 0}
    .dot{width:8px;height:8px;border-radius:999px;display:inline-block;margin-right:6px}.g{background:#33d08f}.y{background:#f0c24e}.r{background:#ff637f}

    .team-layout{padding:10px;display:grid;gap:10px}
    .mission-box{padding:10px;border:1px solid #35568d;border-radius:12px;background:linear-gradient(180deg,#142646,#101d36)}
    .tree{padding:10px;border:1px solid #35568d;border-radius:12px;background:linear-gradient(180deg,#142646,#101d36)}
    .tree ul{list-style:none;margin:0;padding-left:18px}.tree li{margin:6px 0;position:relative}.tree li:before{content:'';position:absolute;left:-10px;top:10px;width:8px;height:1px;background:#3e5f96}
    .team-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .team-card{background:linear-gradient(180deg,#142646,#101d36);border:1px solid #35568d;border-radius:12px;padding:10px}
    .xp-badge{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid #3b6eaa;background:#14315a;color:#cfe4ff}
    .level{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid #6f5a27;background:#372b12;color:#ffe3a4}
    .streak{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid #2f8a6d;background:#143426;color:#b8f5da}
    .leaderboard{margin-top:8px;padding:8px;border:1px solid #35568d;border-radius:12px;background:linear-gradient(180deg,#142646,#101d36)}
    .row{display:flex;gap:10px;align-items:center}
    .avatar{width:42px;height:42px;border-radius:8px;object-fit:cover;border:1px solid #4168a8;image-rendering:pixelated;background:#dfe4ee;padding:2px}
    .muted{color:var(--muted)}

    .docs-layout,.memory-layout{padding:10px;display:grid;grid-template-columns:260px 1fr;gap:10px}
    .list{border:1px solid #35568d;border-radius:12px;background:linear-gradient(180deg,#142646,#101d36);padding:8px;max-height:70vh;overflow:auto}
    .list button{width:100%;text-align:left;background:#12213c;border:1px solid #2e4b79;color:#d8e7ff;border-radius:8px;padding:7px 8px;margin:4px 0;cursor:pointer}
    .viewer{border:1px solid #35568d;border-radius:12px;background:linear-gradient(180deg,#142646,#101d36);padding:10px;max-height:70vh;overflow:auto;white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px}
    .search{width:100%;padding:8px;border-radius:8px;border:1px solid #345286;background:#0f1f3b;color:#dce8ff;margin-bottom:8px}

    .hidden{display:none !important}
    .modal{display:none;position:fixed;inset:0;background:rgba(3,8,18,.75);z-index:80;align-items:center;justify-content:center;padding:18px}
    .modal-card{width:min(900px,95vw);max-height:85vh;overflow:auto;background:#0f1a31;border:1px solid #2f4d82;border-radius:14px;padding:12px}

    @media (max-width:1200px){
      .topbar{grid-template-columns:1fr;gap:6px;padding:8px}
      .fitz{justify-self:start}
      .topstats{justify-self:start;overflow:auto;width:100%}
      .shell{grid-template-columns:1fr}
    }

  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand"><div class="logo">üõ∞Ô∏è</div><div><div style="font-weight:800;letter-spacing:.08em">MISSION CONTROL</div><div class="subtitle" id="updated">Laddar...</div></div></div>
    <div class="fitz"><span>FITZ</span>WORKS</div>
    <div class="topstats" id="topstats"></div>
  </header>

  <div class="shell">
    <aside class="sidebar">
      <button class="tab active" data-tab="tasks">Tasks</button>
      <button class="tab" data-tab="team">Team</button>
      <button class="tab" data-tab="ops">Ops</button>
      <button class="tab" data-tab="memory">Memory</button>
      <button class="tab" data-tab="youtube">YouTube</button>
      <button class="tab" data-tab="archive">Archive</button>
      <button class="tab" data-tab="docs">Docs</button>
    </aside>

    <main class="main">
      <section id="view-tasks">
        <div class="tasks-layout">
          <div class="panel board-wrap"><div class="board" id="board"></div></div>
          <div class="panel" style="padding:8px">
            <div class="section-h" style="padding-top:2px"><span>Tool Status</span><span>Telegram + exec</span></div>
            <div class="ops-box" id="ops"></div>
            <div class="section-h" style="padding-top:2px"><span>Agent Leaderboard</span><span>XP</span></div>
            <div class="leaderboard" id="leaderboard"></div>
          </div>
        </div>
      </section>

      <section id="view-team" class="hidden panel team-layout">
        <div class="mission-box"><b>Mission Statement</b><div class="muted" style="margin-top:6px">Vi bygger en local-first AI workforce som omvandlar id√©er till konkreta resultat, skapar l√•ngsiktig passiv inkomst och minskar Patriks mentala belastning genom struktur, automation och daglig progression.</div></div>
        <div class="tree"><b>FitzWorks Workforce Tree</b>
          <ul>
            <li><b>Bob</b> (Chief Orchestrator)
              <ul>
                <li>Core Team
                  <ul>
                    <li>Max Mercer ‚Äî operations lead</li>
                    <li>Nina Sparks ‚Äî research lead</li>
                    <li>Leo Byte ‚Äî build lead</li>
                    <li>Ivy Shield ‚Äî QA/risk lead</li>
                    <li>Owen Flux ‚Äî ops automation lead</li>
                  </ul>
                </li>
                <li>Specialist Units
                  <ul>
                    <li>Maya Yield ‚Äî passive income unit</li>
                    <li>Rex Droid ‚Äî Android venture unit</li>
                    <li>Zoe Pulse ‚Äî use-case discovery unit</li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </div>
        <div class="leaderboard"><div class="section-h" style="padding:0 0 8px 0"><span>Workforce Activity</span><span>live</span></div><div id="teamActivity"></div></div>
        <div class="team-grid" id="teamGrid"></div>
      </section>

      <section id="view-ops" class="hidden panel" style="padding:10px">
        <div class="section-h"><span>Ops Overview</span><span>FitzWorks</span></div>
        <div class="stats-grid" id="opsStats"></div>
        <div class="ops-box" id="opsDetails"></div>
      </section>

      <section id="view-memory" class="hidden panel memory-layout">
        <div class="list">
          <input class="search" id="memorySearch" placeholder="S√∂k i minnesbanken..." />
          <div id="memoryList"></div>
        </div>
        <div class="viewer" id="memoryViewer">V√§lj en post i v√§nsterlistan.</div>
      </section>

      <section id="view-youtube" class="hidden panel docs-layout">
        <div class="list">
          <input class="search" id="ytSearch" placeholder="S√∂k titel/kanal/kategori..." />
          <div id="ytList"></div>
        </div>
        <div class="viewer" id="ytViewer">V√§lj en video i listan.</div>
      </section>

      <section id="view-archive" class="hidden panel" style="padding:10px">
        <div class="section-h"><span>Archived Tasks</span><span>history</span></div>
        <div id="archiveTabList" class="list" style="max-height:none"></div>
      </section>

      <section id="view-docs" class="hidden panel docs-layout">
        <div class="list" id="docsList"></div>
        <div class="viewer" id="docsViewer">V√§lj ett dokument.</div>
      </section>
    </main>
  </div>

  <div id="archiveModal" class="modal"><div class="modal-card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;"><b>Archived Tasks</b><button id="closeArchive" class="btn">St√§ng</button></div><div id="archiveList" class="muted">Inga arkiverade tasks.</div></div></div>
  <div id="cardModal" class="modal"><div class="modal-card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;"><b>Task details</b><button id="closeCard" class="btn">St√§ng</button></div><div id="cardDetail"></div></div></div>

<script>
const AVATAR_VER='v5';
const TEAM=[
  {name:'Max Mercer',role:'Orchestrator & priorities',personality:'Lugn, strukturerad, beslutsam',focus:'WIP, prioritering, taskflow',state:'Active',model:'gpt-5.3-codex',avatar:`./avatars/max-mercer.png?${AVATAR_VER}`},
  {name:'Nina Sparks',role:'Research & trend radar',personality:'Nyfiken, snabb, selektiv',focus:'signals√∂kning, trendtolkning',state:'Active',model:'ollama/qwen3:8b-16k',avatar:`./avatars/nina-sparks.png?${AVATAR_VER}`},
  {name:'Leo Byte',role:'Builder & app maker',personality:'Pragmatisk, leveransfokuserad',focus:'prototyper, implementation',state:'Idle',model:'ollama/qwen2.5-coder:7b-instruct-16k',avatar:`./avatars/leo-byte.png?${AVATAR_VER}`},
  {name:'Ivy Shield',role:'QA & risk guardian',personality:'Noggrann, skeptisk, trygg',focus:'risk, verifiering, kvalitet',state:'Idle',model:'ollama/MFDoom/deepseek-r1-tool-calling:8b-16k',avatar:`./avatars/ivy-shield.png?${AVATAR_VER}`},
  {name:'Owen Flux',role:'Ops & automation',personality:'Systematisk, stabil',focus:'cron, drift, underh√•ll',state:'Active',model:'ollama/qwen3:4b-16k',avatar:`./avatars/owen-flux.png?${AVATAR_VER}`},
  {name:'Maya Yield',role:'Passive Income Agent',personality:'Aff√§rsskarp, t√•lmodig',focus:'fiat/krypto opportunities',state:'Active',model:'ollama/MFDoom/deepseek-r1-tool-calling:8b-16k',avatar:`./avatars/nina-sparks.png?${AVATAR_VER}`},
  {name:'Rex Droid',role:'Android Venture Agent',personality:'Byggare, experimentell',focus:'id√©‚ÜíMVP‚ÜíPlay Store',state:'Active',model:'ollama/qwen2.5-coder:7b-instruct-16k',avatar:`./avatars/leo-byte.png?${AVATAR_VER}`},
  {name:'Zoe Pulse',role:'Use-case Research Agent',personality:'Signalj√§gare, snabbsynt',focus:'OpenClaw use-cases',state:'Active',model:'ollama/qwen3:8b-16k',avatar:`./avatars/ivy-shield.png?${AVATAR_VER}`}
];
const MODEL_SHORT={'gpt-5.3-codex':'gpt-5.3-codex','ollama/qwen3:8b-16k':'qwen3 8b','ollama/qwen2.5-coder:7b-instruct-16k':'qwen2.5-coder 7b','ollama/MFDoom/deepseek-r1-tool-calling:8b-16k':'deepseek-r1 8b','ollama/qwen3:4b-16k':'qwen3 4b'};
const WIP={doing:2,review:2};
const COLS=[['backlog','Backlog'],['doing','In Progress'],['review','Review'],['done','Done']];
const DEVICE_PROFILE={name:'Mac mini M4 (16GB/256GB)',limits:{cpu:{warn:65,bad:85},ram:{warn:75,bad:90},disk:{warn:80,bad:92},temp:{warn:78,bad:90},net:{warn:2000,bad:8000}}};
const DOC_FILES=['MISSION.md','SOUL.md','CUSTOM_TOOLS.md','SEMANTIC_MEMORY.md','NOTES.md','DECISIONS.md','USER_PROFILE.md'];
const MEMORY_FILES=['MEMORY.md','VOICE_INBOX.md','VOICE_TRIAGE.md','KANBAN_ARCHIVE.json','memory/2026-02-20.md'];
let FOCUS=false,AGENT_FILTER='ALL',TOOL_STATUS={telegram:'OK',exec:'OK'},LAST_ARCHIVE={archived:[]},LAST_BOARD=null,LAST_STATS=null;
let LAST_STATS_SOURCE='./system_stats.json';
const byId=id=>document.getElementById(id); const el=(t,c,h)=>{const e=document.createElement(t);if(c)e.className=c;if(h!==undefined)e.innerHTML=h;return e};

function switchTab(name){['tasks','team','ops','memory','youtube','archive','docs'].forEach(x=>byId('view-'+x).classList.toggle('hidden',x!==name));document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active',b.dataset.tab===name));}

function renderTopStats(data, archivedCount=0){
  const vals={backlog:(data.columns.backlog||[]).length,doing:(data.columns.doing||[]).length,review:(data.columns.review||[]).length,done:(data.columns.done||[]).length};
  const top=byId('topstats'); top.innerHTML='';
  [`Backlog ${vals.backlog}`,`In Progress ${vals.doing}/${WIP.doing}`,`Review ${vals.review}/${WIP.review}`,`Done ${vals.done}`,`Archived ${archivedCount}`,`Agents ${TEAM.length}`].forEach(x=>top.appendChild(el('span','pill',x)));
  const filter=document.createElement('select'); filter.className='agent-filter'; const opts=['ALL',...TEAM.map(a=>a.name)];
  filter.innerHTML=opts.map(n=>`<option value="${n}" ${AGENT_FILTER===n?'selected':''}>${n==='ALL'?'All agents':n}</option>`).join('');
  filter.onchange=e=>{AGENT_FILTER=e.target.value; if(LAST_BOARD) renderBoard(LAST_BOARD);}; top.appendChild(filter);
  const focus=el('button','btn',FOCUS?'Exit Focus':'Focus Mode'); focus.onclick=()=>{FOCUS=!FOCUS; if(LAST_BOARD){renderBoard(LAST_BOARD); renderTopStats(LAST_BOARD,(LAST_ARCHIVE.archived||[]).length);} }; top.appendChild(focus);
}

function findAgent(name){return TEAM.find(a=>a.name===name)||TEAM[0];}
function renderBoard(data){
  const board=byId('board'); board.innerHTML=''; const cols=FOCUS?COLS.filter(([k])=>['doing','review'].includes(k)):COLS;
  board.style.gridTemplateColumns=`repeat(${cols.length}, minmax(220px, 1fr))`;
  cols.forEach(([k,label])=>{
    const base=data.columns[k]||[]; const items=AGENT_FILTER==='ALL'?base:base.filter(t=>(t.agent||'Max Mercer')===AGENT_FILTER);
    const col=el('section','col col-'+k); let count=String(items.length); if(k==='doing')count=`${items.length}/${WIP.doing}`; if(k==='review')count=`${items.length}/${WIP.review}`;
    col.innerHTML=`<div class="colhead ${((k==='doing'&&items.length>=WIP.doing)||(k==='review'&&items.length>=WIP.review))?'soft-limit':''}"><div class="coltitle">${label}</div><div class="count">${count}</div></div>`;
    if(!items.length) col.appendChild(el('div','muted','Inga kort.')); items.forEach(t=>col.appendChild(renderCard(t,k))); board.appendChild(col);
  });
}

function renderCard(t,colKey){
  const p=t.priority||'M';
  const agentName=t.agent||'Max Mercer';
  const a=findAgent(agentName);
  const cat=t.category || (t.tags&&t.tags[0]) || 'general';
  const progress = Number.isFinite(Number(t.progress_pct)) ? Math.max(0, Math.min(100, Number(t.progress_pct))) : (colKey==='done'?100:(colKey==='review'?85:(colKey==='doing'?55:15)));
  const eta = t.eta || (colKey==='doing'?'~1-2 dagar':'-');
  const deadline = t.deadline || '-';
  const card=el('article','card',`<div class="agent-chip"><img src="${a.avatar}" alt="${a.name}"/><span class="tag">${a.name.split(' ')[0]}</span><span class="tag prio-${p}">Prio ${p}</span><span class="tag cat-chip">${cat}</span></div><div class="next" title="${t.next_action||''}">${t.next_action||'(saknar next action)'}</div><div class="progress"><div class="progress-row"><span>${progress}%</span><span>ETA ${eta}</span><span>Due ${deadline}</span></div><div class="bar"><span style="width:${progress}%"></span></div></div>`);
  card.onclick=()=>openCard(t,colKey);
  return card;
}

function openCard(t,colKey){
  const dod=(t.definition_of_done&&t.definition_of_done.length)?t.definition_of_done:['(saknas)']; const blocked=(colKey==='blocked'&&t.blocked_reason)?`<p><b>Blocked reason:</b> ${t.blocked_reason}</p>`:'';
  byId('cardDetail').innerHTML=`<h3 style="margin:0 0 8px">${t.title||'Untitled'}</h3><p><b>Owner:</b> ${t.owner||'Bob'}</p><p><b>Agent:</b> ${t.agent||'Max Mercer'}</p><p><b>Next action:</b> ${t.next_action||'(saknas)'}</p><p><b>Kategori:</b> ${t.category||'general'}</p><p><b>Progress:</b> ${t.progress_pct ?? "-"}%</p><p><b>ETA:</b> ${t.eta||'-'}</p><p><b>Deadline:</b> ${t.deadline||'-'}</p><p><b>Risk:</b> ${t.risk||'M'} ${t.approval_required?'<span class="tag" style="border-color:#8e4359;background:#3a1721;color:#ffc3cf">Approval required</span>':''}</p><p><b>Definition of Done:</b></p><ul>${dod.map(x=>`<li>${x}</li>`).join('')}</ul>${blocked}`;
  byId('cardModal').style.display='flex';
}

function levelBy(v,lim){if(v===null||v===undefined||Number.isNaN(Number(v))) return ''; v=Number(v); if(v<lim.warn) return 'stat-good'; if(v<lim.bad) return 'stat-warn'; return 'stat-bad';}
function levelPercent(v,kind){const lim=(DEVICE_PROFILE.limits&&DEVICE_PROFILE.limits[kind])?DEVICE_PROFILE.limits[kind]:{warn:70,bad:85}; return levelBy(v,lim);} function levelTemp(t,thermal){if(t!==null&&!Number.isNaN(Number(t))) return levelBy(Number(t),DEVICE_PROFILE.limits.temp); const x=(thermal||'').toLowerCase(); if(x.includes('normal')) return 'stat-good'; if(x.includes('constrained')||x.includes('warning')) return 'stat-warn'; if(x.includes('critical')||x.includes('throttle')) return 'stat-bad'; return '';} function levelNet(v){return levelBy(v,DEVICE_PROFILE.limits.net);}

function renderStats(stats){
  const wrap=byId('stats'); if(!wrap) return; if(!stats){wrap.innerHTML='<div class="muted">Ingen systemdata √§nnu.</div>'; return;}
  const cpu=stats.cpu?.used_percent??null, ram=stats.ram?.used_percent??null, disk=stats.disk?.used_percent??null, temp=stats.temperature?.cpu_c??null, thermal=stats.temperature?.thermal_status||'Unknown', rx=stats.network?.rx_kbps??null, tx=stats.network?.tx_kbps??null;
  const tempText=(temp===null)?'N/A':`${temp}¬∞C`; const tempSub=(temp===null)?`Thermal: ${thermal}`:'CPU temp';
  wrap.innerHTML=''; wrap.appendChild(el('div',`stat ${levelPercent(cpu,'cpu')}`,`<div class='k'>CPU</div><div class='v'>${cpu??'-'}%</div>`)); wrap.appendChild(el('div',`stat ${levelPercent(ram,'ram')}`,`<div class='k'>RAM</div><div class='v'>${ram??'-'}%</div>`)); wrap.appendChild(el('div',`stat ${levelPercent(disk,'disk')}`,`<div class='k'>Disk</div><div class='v'>${disk??'-'}%</div>`)); wrap.appendChild(el('div',`stat ${levelTemp(temp,thermal)}`,`<div class='k'>Temp</div><div class='v'>${tempText}</div><div class='muted'>${tempSub}</div>`)); wrap.appendChild(el('div',`stat ${levelNet(rx)}`,`<div class='k'>Net RX</div><div class='v'>${rx??'-'} KB/s</div>`)); wrap.appendChild(el('div',`stat ${levelNet(tx)}`,`<div class='k'>Net TX</div><div class='v'>${tx??'-'} KB/s</div>`));
  let label='';
  if(stats.updated_at){
    const ts=new Date(stats.updated_at); const age=Math.max(0, Math.floor((Date.now()-ts.getTime())/1000));
    label=`${ts.toLocaleTimeString('sv-SE')} ¬∑ ${age}s`; if(age>10) label += ' ¬∑ STALE';
  }
  byId('statsUpdated').textContent=label;
}
function renderOps(){const ops=byId('ops'); const tool=(TOOL_STATUS.telegram==='OK'&&TOOL_STATUS.exec==='OK')?'OK':((TOOL_STATUS.telegram==='DOWN'||TOOL_STATUS.exec==='DOWN')?'DOWN':'DEGRADED'); const dot=tool==='OK'?'g':(tool==='DEGRADED'?'y':'r'); ops.innerHTML=`<div class='ops-row'><span><span class='dot ${dot}'></span><b>Tool status</b></span><span>${tool}</span></div><div class='ops-row'><span class='muted'>Telegram</span><span>${TOOL_STATUS.telegram}</span></div><div class='ops-row'><span class='muted'>exec</span><span>${TOOL_STATUS.exec}</span></div><div class='ops-row'><span class='muted'>Profile</span><span>${DEVICE_PROFILE.name}</span></div>`;}
function renderTeamActivity(data){const box=byId('teamActivity'); if(!box) return; const tasks=[]; ['doing','review','backlog'].forEach(c=>(data.columns[c]||[]).forEach(t=>tasks.push({...t,_col:c}))); tasks.sort((a,b)=>String(b.updated_at||'').localeCompare(String(a.updated_at||''))); const top=tasks.slice(0,8); if(!top.length){box.innerHTML='<div class="muted">Ingen aktivitet √§nnu.</div>'; return;} box.innerHTML=top.map(t=>`<div class='ops-row'><span class='muted'>${(t.agent||'').split(' ')[0]} ¬∑ ${t._col}</span><span title='${t.title||''}'>${(t.title||'').slice(0,34)}</span></div>`).join('');}

function renderArchive(archive){const modalList=byId('archiveList'); const tabList=byId('archiveTabList'); const items=(archive&&archive.archived)?archive.archived:[]; const html=!items.length?'<div class="muted">Inga arkiverade tasks.</div>':items.slice().reverse().map(t=>`<div class='card'><div class='next'><b>${t.title||'Untitled'}</b></div><div class='next'>${t.next_action||''}</div></div>`).join(''); if(modalList) modalList.innerHTML=html; if(tabList) tabList.innerHTML=html;}

function computeAgentStats(data){
  const stats={};
  TEAM.forEach(a=>stats[a.name]={xp:0,done:0,doing:0,review:0,streak:0,level:1});
  const mapCol=(arr,col)=> (arr||[]).forEach(t=>{
    const n=t.agent||'Max Mercer';
    if(!stats[n]) stats[n]={xp:0,done:0,doing:0,review:0,streak:0,level:1};
    if(col==='done'){stats[n].xp += 120; stats[n].done +=1; stats[n].streak +=1;}
    if(col==='doing'){stats[n].xp += 40; stats[n].doing +=1;}
    if(col==='review'){stats[n].xp += 25; stats[n].review +=1;}
    if(col==='backlog'){stats[n].xp += 8;}
    const prog=Number(t.progress_pct||0); stats[n].xp += Math.floor(prog*0.2);
  });
  mapCol(data.columns.backlog,'backlog');
  mapCol(data.columns.doing,'doing');
  mapCol(data.columns.review,'review');
  mapCol(data.columns.done,'done');
  Object.values(stats).forEach(v=>{ v.level = Math.max(1, Math.floor(v.xp/150)+1); });
  return stats;
}

function renderLeaderboard(agentStats){
  const box=byId('leaderboard');
  const rows=Object.entries(agentStats).sort((a,b)=>b[1].xp-a[1].xp).slice(0,8);
  if(!rows.length){box.innerHTML='<div class="muted">Ingen data √§nnu.</div>'; return;}
  box.innerHTML=rows.map(([name,s],i)=>`<div class='ops-row'><span>${i+1}. ${name.split(' ')[0]}</span><span>${s.xp} XP ¬∑ L${s.level}</span></div>`).join('');
}

function latestTasksByAgent(data){const map={}; ['doing','review','backlog','done'].forEach(col=>(data.columns[col]||[]).forEach(t=>{const n=t.agent||'Max Mercer'; const prev=map[n]; if(!prev||String(t.updated_at||'')>String(prev.updated_at||'')) map[n]={...t,_col:col};})); return map;}
function renderTeam(agentStats,data){const g=byId('teamGrid'); g.innerHTML=''; const latest=latestTasksByAgent(data); TEAM.forEach(a=>{ const s=(agentStats&&agentStats[a.name])?agentStats[a.name]:{xp:0,level:1,streak:0}; const t=latest[a.name]; const nowTask=t?`${t.title||t.next_action||'Utan titel'}`:'Ingen aktiv task'; const nowState=t?`${t._col.toUpperCase()}${t.deadline?` ¬∑ Due ${t.deadline}`:''}`:'IDLE'; g.appendChild(el('div','team-card',`<div class='row'><img class='avatar' src='${a.avatar}' alt='${a.name}'/><div><b>${a.name}</b><div class='muted'>${a.role}</div><div class='muted'>Model: ${MODEL_SHORT[a.model]||a.model}</div></div></div><div style='display:flex;gap:6px;margin-top:8px'><span class='xp-badge'>${s.xp} XP</span><span class='level'>Level ${s.level}</span><span class='streak'>Streak ${s.streak}</span></div><div class='muted' style='margin-top:8px'>Nu: ${nowTask}</div><div class='muted'>Status: ${nowState}</div><div class='muted'>Huvudomr√•de: ${a.focus}</div>`)); });}

async function renderDocs(){const list=byId('docsList'); const viewer=byId('docsViewer'); list.innerHTML=''; DOC_FILES.forEach(f=>{const b=document.createElement('button'); b.textContent=f; b.onclick=async()=>{try{const r=await fetch('./'+f+'?ts='+Date.now()); viewer.textContent=await r.text();}catch{viewer.textContent='Kunde inte l√§sa fil.';}}; list.appendChild(b);});}
async function renderMemory(){const list=byId('memoryList'); const viewer=byId('memoryViewer'); const search=byId('memorySearch'); const entries=[]; for(const f of MEMORY_FILES){try{const r=await fetch('./'+f+'?ts='+Date.now()); const txt=await r.text(); entries.push({file:f,text:txt});}catch{}}
  function draw(filter=''){list.innerHTML=''; entries.filter(e=>!filter||e.text.toLowerCase().includes(filter.toLowerCase())||e.file.toLowerCase().includes(filter.toLowerCase())).forEach(e=>{const b=document.createElement('button'); b.textContent=e.file; b.onclick=()=>{viewer.textContent=e.text;}; list.appendChild(b);}); if(!list.children.length) list.innerHTML='<div class="muted">Inga tr√§ffar.</div>';}
  search.oninput=()=>draw(search.value); draw('');}
function parseBankRows(md){
  const rows=[];
  const lines=(md||'').split('\n').filter(Boolean);
  for(const line of lines){
    if(!line.startsWith('|')) continue;
    if(/^\|[\-\s|]+\|$/.test(line)) continue;
    const cols=line.split('|').map(s=>s.trim()).filter((_,i,a)=>i>0&&i<a.length-1);
    if(cols[0]==='Datum') continue;
    // New format: date,title,channel,categories,status,link,notes
    if(cols.length>=7){
      const match=(cols[5]||'').match(/\[(.*?)\]\((.*?)\)/);
      rows.push({date:cols[0],title:cols[1],channel:cols[2],categories:cols[3],status:cols[4],file:(match?match[2]:''),notes:cols[6]});
      continue;
    }
    // Legacy format fallback: date,title,channel,status,link,notes
    if(cols.length>=6){
      const match=(cols[4]||'').match(/\[(.*?)\]\((.*?)\)/);
      rows.push({date:cols[0],title:cols[1],channel:cols[2],categories:'√ñvrigt',status:cols[3],file:(match?match[2]:''),notes:cols[5]});
    }
  }
  return rows;
}

async function renderYoutube(){
  const list=byId('ytList'); const viewer=byId('ytViewer'); const search=byId('ytSearch');
  try{
    const bankRes=await fetch('./research/youtube/BANK.md?ts='+Date.now());
    if(!bankRes.ok){list.innerHTML='<div class="muted">Ingen YouTube-bank hittad √§nnu.</div>'; return;}
    const md=await bankRes.text();
    const rows=parseBankRows(md).sort((a,b)=>String(b.date).localeCompare(String(a.date)));
    function draw(q=''){
      const s=q.toLowerCase();
      const filt=rows.filter(r=>!s || [r.title,r.channel,r.categories,r.status,r.notes].join(' ').toLowerCase().includes(s));
      list.innerHTML='';
      if(!filt.length){list.innerHTML='<div class="muted">Inga tr√§ffar.</div>'; return;}
      const groups={};
      filt.forEach(r=>{const k=(r.categories||'√ñvrigt').split(',')[0].trim()||'√ñvrigt'; (groups[k]=groups[k]||[]).push(r);});
      Object.keys(groups).sort().forEach(cat=>{
        const h=document.createElement('div');
        h.className='muted'; h.style.margin='8px 4px 4px'; h.style.fontWeight='700';
        h.textContent=`${cat} (${groups[cat].length})`;
        list.appendChild(h);
        groups[cat].forEach(r=>{
          const b=document.createElement('button');
          b.innerHTML=`<div><b>${r.title}</b></div><div class='muted'>${r.date} ¬∑ ${r.channel} ¬∑ ${r.status}</div><div class='muted'>Kategori: ${r.categories}</div><div class='muted'>${r.notes}</div>`;
          b.onclick=async()=>{
            try{
              const path='./research/youtube/'+r.file;
              const res=await fetch(path+'?ts='+Date.now());
              viewer.textContent=await res.text();
            }catch{viewer.textContent='Kunde inte l√§sa analysfil.';}
          };
          list.appendChild(b);
        });
      });
    }
    search.oninput=()=>draw(search.value);
    draw('');
  }catch{list.innerHTML='<div class="muted">YouTube-vyn kunde inte laddas.</div>';}
}

function renderOpsTab(){const s=byId('opsStats'); const d=LAST_STATS; if(!d){s.innerHTML='<div class="muted">Ingen statsdata.</div>'; return;} s.innerHTML='<div class="muted">Systemstatus visas i separat rutin (Telegram alerts).</div>'; byId('opsDetails').innerHTML=byId('ops').innerHTML + `<div class='ops-row'><span class='muted'>Refresh</span><span>2s</span></div><div class='ops-row'><span class='muted'>Stats source</span><span style='max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap'>${LAST_STATS_SOURCE}</span></div>`;}

function resolveStatsSource(){
  const p=new URLSearchParams(window.location.search);
  const q=p.get('stats_api');
  const ls=localStorage.getItem('mc_stats_api')||'';
  const src=q||ls||'./system_stats.json';
  LAST_STATS_SOURCE=src;
  return src;
}

async function fetchStats(ts){
  const src=resolveStatsSource();
  const token=localStorage.getItem('mc_stats_token')||'';
  const headers={}; if(token) headers['x-api-key']=token;
  const url = src.includes('?') ? `${src}&ts=${ts}` : `${src}?ts=${ts}`;
  const res=await fetch(url,{headers});
  if(!res.ok) throw new Error(`stats fetch failed ${res.status}`);
  return await res.json();
}

async function load(){
  try{
    const ts=Date.now(); const [boardRes,archiveRes,statsObj]=await Promise.all([fetch('./KANBAN.json?ts='+ts),fetch('./KANBAN_ARCHIVE.json?ts='+ts).catch(()=>null),fetchStats(ts).catch(()=>null)]);
    const data=await boardRes.json(); let stats=statsObj, archive={archived:[]}, archivedCount=0; if(archiveRes&&archiveRes.ok){archive=await archiveRes.json(); archivedCount=(archive.archived||[]).length;}
    LAST_BOARD=data; LAST_ARCHIVE=archive; LAST_STATS=stats;
    byId('updated').textContent=`Senast uppdaterad: ${new Date().toLocaleString('sv-SE')}`;
    const agentStats=computeAgentStats(data);
    renderTopStats(data,archivedCount); renderBoard(data); renderStats(stats); renderOps(); renderLeaderboard(agentStats); renderArchive(archive); renderTeam(agentStats,data); renderTeamActivity(data); renderOpsTab();
  }catch{byId('updated').textContent='Kunde inte l√§sa data'; TOOL_STATUS.exec='DEGRADED'; renderOps();}
}

document.querySelectorAll('.tab').forEach(b=>b.onclick=()=>switchTab(b.dataset.tab));
byId('closeArchive').onclick=()=>byId('archiveModal').style.display='none'; byId('archiveModal').addEventListener('click',e=>{if(e.target.id==='archiveModal')byId('archiveModal').style.display='none';}); byId('closeCard').onclick=()=>byId('cardModal').style.display='none'; byId('cardModal').addEventListener('click',e=>{if(e.target.id==='cardModal')byId('cardModal').style.display='none';});

switchTab('tasks'); renderDocs(); renderMemory(); renderYoutube(); load(); setInterval(load,2000);
</script>
</body>
</html>